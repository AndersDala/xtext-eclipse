/*******************************************************************************
 * Copyright (c) 2017 itemis AG (http://www.itemis.de) and others.
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *******************************************************************************/
package org.eclipse.xtext.ui.wizard.template;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import org.apache.log4j.Logger;
import org.eclipse.core.runtime.IStatus;
import org.eclipse.core.runtime.Status;
import org.eclipse.xtext.ui.util.ProjectFactory;
import org.eclipse.xtext.ui.wizard.IProjectInfo;

/**
 * A template definition for a project, used by the new project wizard. Defines the UI (label, description, icon, variables) on how to
 * present the template to the user and a list or {@link ProjectFile} elements to be generated by the wizard when the template is selected.
 * The {@link ProjectFile}'s can contain references to {@link ProjectVariable}'s to allow the user to configure the generated code.
 * 
 * Instances of this class are generated from classes annotated with {@link ProjectTemplate}.
 * 
 * @author Arne Deutsch - Initial contribution and API
 * @since 2.14
 */
public abstract class AbstractProjectTemplate {

	private static final Logger logger = Logger.getLogger(AbstractProjectTemplate.class);

	protected List<ProjectVariable> variables = new ArrayList<>();

	private IProjectInfo projectInfo;
	
	/**
	 * Create a new text variable with associated text field and add it to the "variables" list.
	 */
	protected StringProjectVariable text(String name, String defaultValue, String description) {
		StringProjectVariable variable = new StringProjectVariable(name, defaultValue, description);
		variables.add(variable);
		return variable;
	}

	/**
	 * Create a new boolean variable with associated check box and add it to the "variables" list.
	 */
	protected BooleanProjectVariable check(String name, boolean defaultValue, String description) {
		BooleanProjectVariable variable = new BooleanProjectVariable(name, defaultValue, description);
		variables.add(variable);
		return variable;
	}

	/**
	 * Create a new text variable with associated combo box and add it to the "variables" list.
	 */
	protected StringSelectionProjectVariable combo(String name, String[] possibleValues, String description) {
		StringSelectionProjectVariable variable = new StringSelectionProjectVariable(name, possibleValues, description);
		variables.add(variable);
		return variable;
	}

	/**
	 * @return The label read from the {@link ProjectTemplate} annotation.
	 */
	public final String getLabel() {
		return getLocalizedValue("Label");
	}

	/**
	 * @return The icon read from the {@link ProjectTemplate} annotation.
	 */
	public final String getIcon() {
		return getProjectTemplateAnnotation().icon();
	}

	/**
	 * @return The description read from the {@link ProjectTemplate} annotation.
	 */
	public final String getDescription() {
		return getLocalizedValue("Description");
	}

	private String getLocalizedValue(String fieldName) {
		try {
			return (String) getClass().getClassLoader().loadClass(getClass().getPackage().getName() + ".Messages")
					.getField(getClass().getSimpleName() + "_" + fieldName).get(null);
		} catch (IllegalArgumentException | IllegalAccessException | NoSuchFieldException | SecurityException | ClassNotFoundException e) {
			logger.error("Can not determine '" + fieldName + "'", e);
			return "NOT AVAILABLE";
		}
	}

	/**
	 * @return The variables read reflectively from this class.
	 */
	public final List<ProjectVariable> getVariables() {
		return Collections.unmodifiableList(variables);
	}

	/**
	 * Subclasses have to override. Generate all the projects to be created when the wizard is finished.
	 * @param generator The generator to supply {@link org.eclipse.xtext.ui.util.ProjectFactory}'s to create projects from.
	 */
	public abstract void generateProjects(IProjectGenerator generator);

	protected ProjectFactory addFile(ProjectFactory project, CharSequence fileName, CharSequence contents) {
		project.addContributor(new TextFileContributor(fileName, contents));
		return project;
	}
	
	protected IProjectInfo getProjectInfo() {
		return projectInfo;
	}
	
	protected void setProjectInfo(IProjectInfo projectInfo) {
		this.projectInfo = projectInfo;
	}

	/**
	 * Subclasses should override to validate the variables. If everything is ok {@link Status#OK_STATUS} should be returned. Otherwise an
	 * ERROR or WARNING Status might be returned whereas the message is displayed to the user.
	 */
	protected IStatus validate() {
		return Status.OK_STATUS;
	}

	/**
	 * Subclasses should override. The method is called after each change of a variable value through the user. It can be used to
	 * enable/disable variables (calling {@link ProjectVariable#setEnabled(boolean)}) in the UI or change values further in reaction to a
	 * user change. Does nothing by default.
	 */
	protected void updateVariables() {
	}

	private ProjectTemplate getProjectTemplateAnnotation() {
		Class<? extends Object> projectTemplateClass = getClass();
		ProjectTemplate projectTemplateAnnotation = projectTemplateClass.getAnnotation(ProjectTemplate.class);
		if (projectTemplateAnnotation == null)
			throw new RuntimeException("Template class '" + projectTemplateClass.getName() + "' does not declare a '"
					+ ProjectTemplate.class.getName() + "' annotation");
		return projectTemplateAnnotation;
	}

}
